<?php

use Application\View\Helper\BotaoSimples;
use Application\Controller\Helper\Funcoes;
use Application\Controller\RelatorioController;
use Application\Model\Entity\FuncoesEntidade;
use Application\Model\Entity\EntidadeTipo;
use Application\Model\Entity\Situacao;
use Application\Model\Entity\Hierarquia;

if ($this->mostrarPrincipal) {
	$fotos = $this->grupo->getFotosLideresAtivos(128);
  echo '<div class="alert alert-default">';
	echo $this->sitemap('principal');
	echo '</div>';
?>
<div class="panel mt10">
<div class="panel-body ">

<div class="media clearfix">
<div class="media-left pr5">
<?php echo '<img src="/img/fotos/'.$this->pessoa->getFoto().'" class="user-avatar" width="100px" height="100px" />'; ?>
</div>
<div class="media-body va-m">
<h4><?php echo $this->pessoa->getNomePrimeiroUltimo(); ?></h4>
<small><?php echo $this->entidade->infoEntidade(); ?></small>
<p class="mt10"><?php
	if($this->pessoaLogada->getId() === $this->pessoa->getId()){
		$funcaoOnClickPerfil = 'location.href="/perfil"';
		echo $this->botaoSimples('<i class="fa fa-user"></i> Perfil', $this->funcaoOnClick($funcaoOnClickPerfil), BotaoSimples::botaoMuitoPequenoImportante, BotaoSimples::posicaoAEsquerda);
	} else {
	$funcaoOnClick = 'funcaoCircuito("principalVer", '.$grupo->getId().')';
	echo $this->botaoSimples('<i class="fa fa-cog"></i>', $this->funcaoOnClick($funcaoOnClick), BotaoSimples::botaoMuitoPequenoImportante, BotaoSimples::posicaoAEsquerda); }	?>
</p>
</div>
</div>

</div>
</div>

<!-- fim panel meus dados -->

<div class="alert alert-default text-center">
Último acesso: <?php echo $this->ultimoAcesso; ?>
</div>

<div class="alert alert-default text-center">
Período Atual <?php echo Funcoes::montaPeriodo($this->periodoFinal)[0]; ?>
</div>

<div class="row mb10">
<?php
	$totalDeIndices = 6;
	if($this->pessoa->getPessoaHierarquiaAtivo() 
		&& $this->pessoa->getPessoaHierarquiaAtivo()->getHierarquia()->getId() !== Hierarquia::LIDER_EM_TREINAMENTO
		&& $this->pessoa->getPessoaHierarquiaAtivo()->getHierarquia()->getId() !== Hierarquia::LIDER_DE_CELULA){
			if($this->discipulado){
				$totalDeIndices = 9;

				$contador = array();
				$contador['M'] = 0;
				$contador['F'] = 0;
				foreach($discipulos as $discipulo){
					$grupoFilho = $discipulo->getGrupoPaiFilhoFilho();
					foreach($grupoFilho->getPessoasAtivas() as $pessoa){
						if ($pessoa->getSexo() === 'M') {
							$contador['M']++;
						}
						if ($pessoa->getSexo() === 'F') {
							$contador['F']++;
						}
						$contador[0]++;
					}
				}
				$diferenca = $contador[0] - ($contador['M']+$contador['F']);
				if($diferenca > 0){
					$totalDeIndices = 10;
				}
			}
		}
	for($indiceNumeroGrandes = 1; $indiceNumeroGrandes <= $totalDeIndices; $indiceNumeroGrandes++){
		$valor = 0;
		$label = '';
		switch($indiceNumeroGrandes){
		case 1:
			$valor = $this->relatorio[0][$this->periodoFinal]['celulaQuantidade'];
			$label = 'Célula(s)';
			break;
		case 2:
			$valor = $this->relatorio[0][$this->periodoFinal]['quantidadeLideres'];
			$label = 'Líder(es)';
			break;
		case 3:
			$valor = number_format($this->relatorio[0][$this->periodoFinal]['membresia']);
			$label = 'Membresia';
			break;
		case 4:
			$valor = 'R$ '.number_format($this->relatorioParceiro[0]['somaValor'],2,',','.');
			$label = 'Parceiro de Deus';
			break;
		case 5:
			$valor = ($this->relatorioCursos['total'][Situacao::ATIVO] + $this->relatorioCursos['total'][Situacao::ESPECIAL]);
			$label = 'Aluno(s)';
			break;
		case 6:
			$valor = $this->totalDeDiscipulados;
			$label = 'Discipulado(s)';
			break;
		case 7:
			$valor = '';
			if($this->discipulado['media']){
				for($i = 1; $i <= 5; $i++){
					if($this->discipulado['media'] >= $i){
						$valor .= '<i class="fa fa-star"></i>';
					}else{
						$valor .= '<i class="fa fa-star-o"></i>';
					}
				}
			}
			$label = 'Discipulado';
			break;
		case 8:
			if($contador['M'] < 6){
				$escala = 'Anêmico';
			}	
			if($contador['M'] >= 6 && $contador['M'] < 12){
				$escala = 'Fraca';
			}	
			if($contador['M'] == 12){
				$escala = 'Boa';
			}
			if($contador['M'] >= 13 && $contador['M'] < 21){
				$escala = 'Preditiva';
			}	
			if($contador['M'] >= 21){
				$escala = 'Forte';
			}	
			$valor = $contador['M'] . ' - ' . $escala;
			$label = 'Time de Homens';
			break;
		case 9:
			if($contador['F'] < 6){
				$escala = 'Anêmico';
			}	
			if($contador['F'] >= 6 && $contador['F'] < 12){
				$escala = 'Fraca';
			}	
			if($contador['F'] == 12){
				$escala = 'Boa';
			}
			if($contador['F'] >= 13 && $contador['F'] < 21){
				$escala = 'Preditiva';
			}	
			if($contador['F'] >= 21){
				$escala = 'Forte';
			}	
			$valor = $contador['F'] . ' - ' . $escala;
			$label = 'Time de Mulheres';
			break;
		case 10:
			$valor = $diferenca;
			$label = 'Sexo não informado';
			break;
		}
		echo '<div class="col-lg-3 col-md-3 col-sm-3 col-xs-6">';
		echo '<div class="panel text-center br-a br-grey">';
		echo '<div class="panel-body">';
		echo '<h1 class="fs16 mt5 mbn">'.$valor.'</h1>';
		echo '<h6 class="text-info">'.$label.'</h6>';
		echo '</div>';
		echo '</div>';
		echo '</div>';
	}
?>
</div>

<!-- fim row numeros grandes -->

<div class="row mb10">

<!-- dados membresia -->
<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 admin-grid">
<div class="panel panel-collapsed" id="p1">
<div class="panel-heading ui-sortable-handle">
Membresia
<span class="panel-controls">
<a href="#" class="panel-control-collapse"></a>
</span>
</div>
<div class="panel-body pn pt10" style="display: none;">

<div class="col-xs-12 col-md-12 col-lg-12 p20">
<p class="relatorioPessoal well text-<?php echo $this->relatorio[0]['mediaMembresiaPerformanceClass']; ?> text-center"><?php echo $this->relatorio[0]['mediaMembresiaPerformanceFrase']; ?></p>
<?php
echo $this->barraDeProgressoBonita(
	'Membresia', $this->relatorio[0]['mediaMembresiaPerformanceClass'], $this->relatorio[0]['mediaMembresiaPerformance'], 'm0', true, $this->relatorio[0][-1]['membresiaMeta'], $this->relatorio[0]['mediaMembresia'], '');
?>
</div>

<?php
$class = 'class = "col-lg-3 col-md-3 col-sm-6 col-xs-12"';
$numeroIndices = 4;
for ($indice = 1; $indice <= $numeroIndices; $indice++) {
	switch ($indice) {
	case 1:
		$label = 'PESSOAS CHEIAS DE F&Eacute;';
		$valor = $this->relatorio[0]['mediaMembresiaCulto'];
		break;
	case 2:
		$label = 'PESSOAS APAIXONADAS';
		$valor = $this->relatorio[0]['mediaMembresiaArena'];
		break;
	case 3:
		$label = 'PESSOAS ALIAN&Ccedil;ADAS';
		$valor = $this->relatorio[0]['mediaMembresiaDomingo'];
		break;
	case 4: $label = 'MEMBROS ASS&Iacute;DUOS';
		$valor = $this->relatorio[0]['mediaMembresia'];
		break;
	}
	$valor = RelatorioController::formataNumeroRelatorio($valor);
?>
								<div <?php echo $class; ?>>
									<div class="panel panel-tile text-center br-a br-grey">
										<div class="panel-body" style="padding-bottom: 0px;">
											<h1 class="fs30 mt5 mbn">
<?php
	echo '<span class = "relatorioPessoal">' . $valor . '</span>';
?>
											</h1>
											<h6><?php echo $label; ?></h6>
										</div>
										<div class="panel-footer br-t p12">
											<span class="fs11">
<?php
	for ($indicePeriodosDoMesAtual = $this->periodoInicial; $indicePeriodosDoMesAtual <= $this->periodoFinal; $indicePeriodosDoMesAtual++) {
		if ($indicePeriodosDoMesAtual != $this->periodoInicial) {
			echo ' | ';
		}
		switch ($indice) {
		case 1:
			$valor = $this->relatorio[0][$indicePeriodosDoMesAtual]['membresiaCulto'];
			break;
		case 2:
			$valor = $this->relatorio[0][$indicePeriodosDoMesAtual]['membresiaArena'];
			break;
		case 3:
			$valor = $this->relatorio[0][$indicePeriodosDoMesAtual]['membresiaDomingo'];
			break;
		case 4:
			$valor = $this->relatorio[0][$indicePeriodosDoMesAtual]['membresia'];
			$valor = RelatorioController::formataNumeroRelatorio($valor);
			break;
		}

		echo '<span class="relatorioPessoal" style="font-size: 10px;">' . $valor . '</span>';
	}
?>
											</span>
										</div>
									</div>
								</div>
<?php } ?>
</div>
</div>
</div>
<!-- fim membresia -->

<!-- dados celula -->
<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 admin-grid">
<div class="panel panel-collapsed" id="p2">
<div class="panel-heading ui-sortable-handle">
Célula
<span class="panel-controls">
<a href="#" class="panel-control-collapse"></a>
</span>
</div>
<div class="panel-body pn pt10" style="display: none;">

<div class="col-xs-12 col-md-12 col-lg-12 p20">
<p class="relatorioPessoal well text-<?php echo $this->relatorio[0]['mediaCelulaPerformanceClass']; ?> text-center"><?php echo $this->relatorio[0]['mediaCelulaPerformanceFrase']; ?></p>
<?php
echo $this->barraDeProgressoBonita(
	'Célula', $this->relatorio[0]['mediaCelulaPerformanceClass'], $this->relatorio[0]['mediaCelulaPerformance'], 'm0', true, $this->relatorio[0][-1]['membresiaMeta'], $this->relatorio[0]['mediaCelula'], '');
?>
</div>


<?php
$class = 'class = "col-lg-4 col-md-4 col-sm-4 col-xs-12"';
$numeroIndices = 3;
for ($indice = 1; $indice <= $numeroIndices; $indice++) {
	switch ($indice) {
	case 1:
		$label = 'TOTAL DE CÉLULAS DE MULTIPLIÇÃO';
		$valor = $this->relatorio[0]['mediaCelulaQuantidade'];
		$valor = RelatorioController::formataNumeroRelatorio($valor);
		break;
	case 2:
		$label = 'PESSOAS FREQUENTE';
		$valor = $this->relatorio[0]['mediaCelula'];
		$valor = RelatorioController::formataNumeroRelatorio($valor);
		break;
	case 3:
		$label = 'CÉLULAS REALIZADAS';
		$valor = $this->relatorio[0]['mediaCelulaRealizadasPerformance'];
		$valor = RelatorioController::formataNumeroRelatorio($valor) . '%';
		break;
	}
?>
								<div <?php echo $class; ?>>
									<div class="panel panel-tile text-center br-a br-grey">
										<div class="panel-body" style="padding-bottom: 0px;">
											<h1 class="fs30 mt5 mbn">
<?php
	echo '<span class = "relatorioPessoal">' . $valor . '</span>';
?>
											</h1>
											<h6><?php echo $label; ?></h6>
										</div>
										<div class="panel-footer br-t p12">
											<span class="fs11">
<?php
	for ($indicePeriodosDoMesAtual = $this->periodoInicial; $indicePeriodosDoMesAtual <= $this->periodoFinal; $indicePeriodosDoMesAtual++) {
		if ($indicePeriodosDoMesAtual != $this->periodoInicial) {
			echo ' | ';
		}
		switch ($indice) {
		case 1:
			$valor = $this->relatorio[0][$indicePeriodosDoMesAtual]['celulaQuantidade'];
			break;
		case 2:
			$valor = $this->relatorio[0][$indicePeriodosDoMesAtual]['celula'];
			break;
		case 3:
			$valor = $this->relatorio[0][$indicePeriodosDoMesAtual]['celulaRealizadasPerformance'];
			$valor = RelatorioController::formataNumeroRelatorio($valor) . '%';
			break;
		}
		$botaoModalPessoal = $valor;
		echo '<span class = "relatorioPessoal" style = "font-size: 10px;">' . $botaoModalPessoal . '</span>';
	}
?>
</span>
										</div>
									</div>
								</div>
<?php } ?>
</div>

</div>
</div>
<!-- fim celula -->

<!-- cursos -->
<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 admin-grid">
<div class="panel panel-collapsed" id="p3">
<div class="panel-heading ui-sortable-handle">
Alunos
<span class="panel-controls">
<a href="#" class="panel-control-collapse"></a>
</span>
</div>
<div class="panel-body pn pt10 p10" style="display: none;">
<div class="alert alert-default">
	Legenda:
	<span class="label label-success" data-placement="bottom" data-toggle="popover" data-content="Ativo" style="cursor: pointer;">A</span>
	<span class="label label-info" data-placement="bottom" data-toggle="popover" data-content="Especial" style="cursor: pointer;">E</span>
	<span class="label label-warning" data-placement="bottom" data-toggle="popover" data-content="Desistente" style="cursor: pointer;">D</span>
	<span class="label label-danger" data-placement="bottom" data-toggle="popover" data-content="Reprovado" style="cursor: pointer;">R</span>
</div>
<?php
	if($this->turmas){
		echo '<div class="row mb10">';
		foreach($this->turmas as $turma){
			$relatorio = $this->relatorioCursos[$turma->getId()];
			if($relatorio[Situacao::ATIVO] == ''){
				$relatorio[Situacao::ATIVO] = 0;
			}
			if($relatorio[Situacao::ESPECIAL] == ''){
				$relatorio[Situacao::ESPECIAL] = 0;
			}
			if($relatorio[Situacao::DESISTENTE] == ''){
				$relatorio[Situacao::DESISTENTE] = 0;
			}
			if($relatorio[Situacao::REPROVADO_POR_FALTA] == ''){
				$relatorio[Situacao::REPROVADO_POR_FALTA] = 0;
			}
			$valor = ($relatorio[Situacao::ATIVO] + $relatorio[Situacao::ESPECIAL]);
			if($valor == ''){
				$valor = 0;
			}
			$modulo = 'SEM AULA ABERTA';
			if($turma->getTurmaAulaAtiva()){
				$modulo = $turma->getTurmaAulaAtiva()->getAula()->getDisciplina()->getNome();
			}
			$label = $modulo.' - ' . Funcoes::mesPorExtenso($turma->getMes(), 1) . '/' . $turma->getAno();
			echo '<div class="col-lg-4 col-md-6 col-sm-6 col-xs-12">';
			echo '<div class="panel panel-tile text-center br-a br-grey">';
			echo '<div class="panel-body" style="padding-bottom: 0px;">';
			echo '<h1 class="fs30 mt5 mbn">'.$valor.'</h1>';
			echo '<h6>'.$label.'</h6>';
			echo '</div>';
			echo '<div class="panel-footer br-t p12">';
			echo '<span class="fs11">';
			echo '<span class="label label-success">A - '.$relatorio[Situacao::ATIVO].'</span>';
			echo ' <span class="label label-info">E - '.$relatorio[Situacao::ESPECIAL].'</span>';
			echo ' <span class="label label-warning">D - '.$relatorio[Situacao::DESISTENTE].'</span>';
			echo ' <span class="label label-danger">R - '.$relatorio[Situacao::REPROVADO_POR_FALTA].'</span>';
			echo '</span>';
			echo '</div>';
			echo '</div>';
			echo '</div>';
		}
		echo '</div>';
	}
?>
</div>

</div>
</div>
<!-- fim cursos -->

<?php
	if($this->discipulado){
?>
<!-- dados discipulado -->
<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 admin-grid">
<div class="panel panel-collapsed" id="p2">
<div class="panel-heading ui-sortable-handle">
Discipulado
<span class="panel-controls">
<a href="#" class="panel-control-collapse"></a>
</span>
</div>
<div class="panel-body pn pt10" style="display: none;">
<?php 
		echo '<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 p10 text-center">';
		echo '<div class="panel">';
		echo '<div class="panel-body pn">';
		foreach($this->discipulado['discipulados'] as $discipulado){
			echo '<div class="alert alert-default">'.$discipulado['info'].'</div>';

			echo '<div class="row">';
			for ($indiceInputs = 1; $indiceInputs <= 6; $indiceInputs++) {
				$input = '';
				$label = '';
				switch ($indiceInputs) {
				case 1:$input = 'lanche'; $label = 'Lanche';break;
				case 2:$input = 'administrativo'; $label = 'Circuito';break;
				case 3:$input = 'oracao'; $label = 'Oração';break;
				case 4:$input = 'palavra'; $label = 'Palavra';break;
				case 5:$input = 'pontualidade'; $label = 'Pontualidade';break;
				case 6:$input = 'assiduidade'; $label = 'Assiduidade';break;
				}
				$estrelas = '';
				echo '<div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 p10 text-center">';
				for($i = 1; $i <= 5; $i++){
					if($discipulado[$input] >= $i){
						$estrelas .= '<i class="fa fa-star"></i>';
					}else{
						$estrelas .= '<i class="fa fa-star-o"></i>';
					}
				}
				echo $label.'<br />';
				echo $estrelas;
				echo '</div>';
			}
			echo '</div>';
		}
		echo '</div>';
		echo '</div>';
		echo '</div>';
?>
</div>
</div>
</div>
<!-- fim dados discipulado -->
<?php } ?>

</div>
<!-- fim row dados -->

<?php
	if(count($this->discipulos) > 0){
?>
<div class="panel user-group-widget">

<div class="panel-heading">
<span class="panel-icon">
<i class="fa fa-users"></i>
</span>
<span class="panel-title">Discípulos</span>
</div>

<div class="panel-body pn">

<?php
		$contadorDeDiscipulosPorLinha = 0;
		foreach($discipulos as $discipulo){
			$grupoFilho = $discipulo->getGrupoPaiFilhoFilho();
			foreach($grupoFilho->getPessoasAtivas() as $pessoa){
				$funcaoOnClick = 'mostrarSplash(); funcaoCircuito("principal", '.$pessoa->getId().')';
				$nomeHierarquia = $pessoa->getPessoaHierarquiaAtivo()->getHierarquia()->getNome();
				if ($pessoa->getSexo() === 'F') {
					if ($nomeFeminino = $pessoa->getPessoaHierarquiaAtivo()->getHierarquia()->getNome_feminino()) {
						$nomeHierarquia = $nomeFeminino;
					}
				}
				if($contadorDeDiscipulosPorLinha === 0){
					echo '<div class="row p10">';
				}
				echo '<div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 p10 text-center">';
				echo '<img src="/img/fotos/'.$pessoa->getFoto().'" class="user-avatar" width="128px" height="128px" '. $this->funcaoOnClick($funcaoOnClick) .'/ style="margin:auto;">';
				echo '<div class="caption">';
				echo '<h5>'.$pessoa->getNomePrimeiro();
				echo '<br />';
				echo '<small>'.$nomeHierarquia. '<small>';
				echo '<br /><small>'.$grupoFilho->getEntidadeAtiva()->infoEntidade(). '<small>';
				echo '</h5>';
				echo '</div>';
				echo '</div>';

				$contadorDeDiscipulosPorLinha++;
				if($contadorDeDiscipulosPorLinha === 3){
					echo '</div>';
					$contadorDeDiscipulosPorLinha = 0;
				}
			}
		}
?>

</div>

</div>

</div>
<!-- fim panel discipulos -->
<?php
	}
} else {
	echo '<div class="panel-body bg-light text-center">';
	if($this->grupo->getId() !== 1 && $this->grupo->getId() !== 1225){
		echo '<h1><span class = "text-danger">Perfil de acesso inativado!</span></h1>';
		echo '<p>Para lançar arregimentação: Menu > Lançar > Arregimentação</p>';
	}else{
		echo '<h1>Dashboard em manutenção</h1>';
	}
	echo '</div>';
}
echo $this->layoutJSPrincipal;
?>
<script>
$(document).ready(function(){
    $('[data-toggle="popover"]').popover();
});
</script>
