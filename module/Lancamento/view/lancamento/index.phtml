<?php

use Doctrine\Common\Collections\Criteria;
use Lancamento\Controller\Helper\ConstantesLancamento;
use Lancamento\Controller\Helper\FuncoesLancamento;

$mesSelecionado = FuncoesLancamento::mesPorAbaSelecionada($this->abaSelecionada);
$anoSelecionado = FuncoesLancamento::anoPorAbaSelecionada($this->abaSelecionada);
?>

<!-- Abertura de Abas -->
<div class="row">
    <div class="col-md-6">
        <?php echo $this->dadosEntidade(); ?>
    </div>
</div>
<div class="panel">
    <div class="panel-heading">
        <ul class="nav panel-tabs-border panel-tabs panel-tabs-left">
            <?php
            $urlBase = $this->url(ConstantesLancamento::$ROUTE_LANCAMENTO);
            $urlBase2 = $urlBase . '/2';
            ?>
            <li role="presentation" <?php echo ConstantesLancamento::$ONCLICK_ABRIR_MODAL; ?> <?php echo $this->abaSelecionada($this->abaSelecionada, 1); ?>><a href="<?php echo $urlBase; ?>">M&ecirc;s Atual</a></li>
            <li role="presentation" <?php echo ConstantesLancamento::$ONCLICK_ABRIR_MODAL; ?> <?php echo $this->abaSelecionada($this->abaSelecionada, 2); ?>><a href="<?php echo $urlBase2; ?>">M&ecirc;s Anterior</a></li>
        </ul>
        <div class="pull-right">
            <div class="btn-group">
                <button class="btn btn-primary btn-sm" onclick="location.href = '/lancamentoCadastrarPessoa';" title="Adicionar Pessoa"><i class="fa fa-plus"></i></button>
            </div>
            <div class="btn-group">
                <button class="btn btn-success btn-sm" onclick="location.href = '/lancamentoEnviarRelatorio';" title="Enviar Relatório"><i class="fa fa-file-text-o"></i></button>
            </div>
        </div>
    </div>
    <div class="panel-body">
        <!-- Cabeçalho do ciclo -->
        <div class="panel-heading row text-center">      
              <span class="panel-title">
                <?php
                    $urlBaseCiclo = $urlBase . '/' . $this->abaSelecionada . '_';
                    if ($this->cicloSelecionado > 1) {
                        $urlCicloAnterior = $urlBaseCiclo . ($this->cicloSelecionado - 1);
                        ?>
                <a <?php echo ConstantesLancamento::$ONCLICK_ABRIR_MODAL; ?> href="<?php echo $urlCicloAnterior; ?>"><button class="btn btn-default btn-sm"><i class="fa fa-angle-double-left"></i></button></a>
                        <?php
                    }
                    ?>    
                    Ciclo <?php echo $this->cicloSelecionado; ?> <?php echo FuncoesLancamento::periodoCicloMesAno($this->cicloSelecionado, $mesSelecionado, $anoSelecionado); ?>
                    <?php
                    $totalDeCiclos = FuncoesLancamento::totalCiclosMes($mesSelecionado, $anoSelecionado);
                    if ($this->cicloSelecionado < $totalDeCiclos) {
                        $urlCicloPosterior = $urlBaseCiclo . ($this->cicloSelecionado + 1);
                        ?>
                        <a <?php echo ConstantesLancamento::$ONCLICK_ABRIR_MODAL; ?> href="<?php echo $urlCicloPosterior; ?>"><button class="btn btn-default btn-sm"><i class="fa fa-angle-double-right"></i></button></a>
                        <?php
                    }
                ?>
              </span>
        </div>
           
        <!-- Tabela de lançamento de dados --> 
        <?php echo $this->tabelaLancamento(); ?>
    </div>
</div>

<!-- Dados do Menu [Entidade] -->
<div class="row">
    
</div>

<!-- Montagem das abas -->
<div class="row">
    <div class="tab-block mb25">
        
        <!-- FIM ABAS SELECIONADAS MODAL COM LOADER GIGANTE -->
        <?php echo $this->modalAba(); ?>
        <!--FIM MODAL COM LOADER GIGANTE-->

        <button class="btn btn-danger btn-lg" onclick="location.href = '/lancamentoCadastrarPessoa';">Novo Cadastro</button>
        <button class="btn btn-danger btn-lg" onclick="location.href = '/lancamentoEnviarRelatorio';">Enviar Relat&oacute;rio</button>

        <div class="tab-content">
            <div id="tab10_1" class="tab-pane active">
                <div id="cabecalhoCiclo" class="row">
                    <div class="col-md-6">
                        <!--Lista de lançamento-->
                        <button class=" btn btn-success" >
                            <i class="fa fa-bolt text-purple"></i>
                        </button>
                    </div>
                    <div class="col-md-6 text-center">
                        <?php
                        $urlBaseCiclo = $urlBase . '/' . $this->abaSelecionada . '_';
                        if ($this->cicloSelecionado > 1) {
                            $urlCicloAnterior = $urlBaseCiclo . ($this->cicloSelecionado - 1);
                            ?>
                            <a <?php echo ConstantesLancamento::$ONCLICK_ABRIR_MODAL; ?> href="<?php echo $urlCicloAnterior; ?>"><i class="btn fa fa-angle-double-left text-purple"></i></a>
                            <?php
                        }
                        ?>    
                        Ciclo {<?php echo $this->cicloSelecionado; ?>} <?php echo FuncoesLancamento::periodoCicloMesAno($this->cicloSelecionado, $mesSelecionado, $anoSelecionado); ?>
                        <?php
                        $totalDeCiclos = FuncoesLancamento::totalCiclosMes($mesSelecionado, $anoSelecionado);
                        if ($this->cicloSelecionado < $totalDeCiclos) {
                            $urlCicloPosterior = $urlBaseCiclo . ($this->cicloSelecionado + 1);
                            ?>
                            <a <?php echo ConstantesLancamento::$ONCLICK_ABRIR_MODAL; ?> href="<?php echo $urlCicloPosterior; ?>"><i class="btn fa fa-angle-double-right text-purple"></i></a>
                            <?php
                        }
                        ?>
                    </div>
                </div>
                <div id="cabecalhoEventos" class="row">
                    <div class="col-md-6">
                        <input class="form-control" placeholder="Buscar nome" />
                    </div>
                    <div class="col-md-6 text-center">
                        {
                        <?php
                        /* Listagem dos eventos */
                        $grupo = $this->entidade->getGrupo();
                        $eventos = $grupo->getGrupoEventoNoCiclo($this->cicloSelecionado);
                        if (count($eventos) > 0) {
                            echo "<div class='row btn-success'>";
                            foreach ($eventos as $ge) {

                                /* Verificar se o evento existe nesse ciclo */
                                echo $ge->getEvento()->getEventoTipo()->getNome() . "|";
                                echo $ge->getEvento()->getDia() . "|";
                                echo $ge->getEvento()->getHora() . " - ";
                            }
                            echo "</div>";
                            echo "<div class='row'>";
                            $cont = 1;
                            foreach ($eventos as $ge) {
                                /* Totais */
                                $evento = $ge->getEvento();
                                $cont++;
                                if ($cont % 2 == 0) {
                                    $class = 'btn-info';
                                } else {
                                    $class = 'btn-danger';
                                }
                                echo "<span id='total_{$evento->getId()}' class='$class'>";
                                $eventoFrequencia = $evento->getEventoFrequencia();
                                $total = 0;
                                if (count($eventoFrequencia) > 0) {
                                    $criteria = Criteria::create()
                                            ->andWhere(Criteria::expr()->eq("ano", $anoSelecionado))
                                            ->andWhere(Criteria::expr()->eq("mes", $mesSelecionado))
                                            ->andWhere(Criteria::expr()->eq("ciclo", $this->cicloSelecionado))
                                            ->andWhere(Criteria::expr()->eq("frequencia", "S"))
                                    ;
                                    $eventosFiltrados = $eventoFrequencia->matching($criteria);
                                    $total = count($eventosFiltrados);
                                }
                                echo "$total";
                                echo "</span>";
                            }
                            echo "</div>";
                        }
                        ?>}
                    </div>
                </div>
            </div>
            <div id="tab10_2" class="tab-pane">
                TAB 2
            </div>
        </div>
    </div>
</div>
<?php
/* Layout com javascript para tela de index */
echo $this->layoutJSLancamento;
